# 项目上线

## 准备项目域名

1. 购买云服务器，推荐 [Vultr] (按时计费，随时创建，随时销毁，对于学习来说既方便又实惠)
2. 购买域名并进行域名备案，推荐 [阿里云万网]
3. 进行域名解析：将域名 `file.epoch.fun` 和 `mall.epoch.fun` 解析到购买的云服务器上

   **域名解析**：建立 `域名 和 IP 地址` 之间的映射关系，使得在浏览器中输入域名时能够通过相应的 IP 访问到真正的服务器

   - 真实的域名解析：通常由域名提供商提供域名解析服务，比如 [阿里云解析]
   - 虚拟的域名解析：修改 `hosts` 配置文件 `/etc/hosts` 的内容，这也是使用 hosts 翻墙的原理

     ```
     # sample
     127.0.0.1 domain
     # example
     127.0.0.1 file.epoch.fun
     ```

## 搭建运行环境

1. 安装项目依赖软件

   我在 [软件安装文档] 中详细记录了部署本项目的软件安装过程

   当然，秉着偷懒的原则，我也在 GitHub 项目 [shell] 中编写了一些自动化脚本，包括但不限于以下功能

   - 一键安装 / 切换 `Maven、Tomcat、Nginx` 的任意版本
   - 一键安装 `JDK、MySQL、Vsftpd` 等常用开发软件
   - 一键部署本项目

2. [搭建 HTTP 图片服务器]

## 初始化数据库

1. 登录数据库

   ```bash
   mysql -u root -p 
   ```

2. 创建数据库

   ```sql
   CREATE DATABASE `mall` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; 
   ```

3. 创建数据表
   1. 下载本项目的 [数据表 SQL 文件]
   2. 上传文件

      示例：上传到上文搭建的文件服务器上 `/home/mall/mall.sql`

   3. 导入文件 `source /home/mall/mall.sql`

4. 添加新用户

   ```sql
   CREATE USER 'mall'@'localhost' IDENTIFIED BY 'mall_pass';
   ```

5. 授予用户权限

   ```sql
   GRANT ALL PRIVILEGES ON mall.* TO mall@localhost IDENTIFIED BY 'mall_pass';
   ```

6. 授予外网权限 (可选)
   1. 授予指定权限

      ```sql
      GRANT CREATE,DROP,SELECT,INSERT,UPDATE,DELETE ON mall.* TO mall@'%' IDENTIFIED BY 'mall_pass';
      ```

   2. 修改配置文件

      ```bash
      sudo sed -i "s/\(^bind-address\)/# \1/" /etc/mysql/mysql.conf.d/mysqld.cnf
      ```

   3. 重启数据库

      ```bash
      sudo service mysql restart
      ```
   4. 配置防火墙，开放 `3306` 端口

## 部署项目代码

1. 下载适用于本文档示例的[生产环境配置文件]
2. 上传至 `/home/mall/resources-demo.tar`
3. 解压至 `$HOME/srccode/resources.pro`

   ```bash
   mkdir -p $HOME/srccode/resources.pro && tar -xvf /home/mall/resources-demo.tar -C $HOME/srccode/resources\.pro/
   ```

4. 添加自动部署脚本 `mall.sh`

   ```bash
   #!/bin/bash
   # 克隆源代码
   [ ! -d "$HOME/srccode/mall" ] && git clone https://github.com/epochwz/mall.git $HOME/srccode/mall
   
   # 更新配置
   cp -rf $HOME/srccode/resources.pro $HOME/srccode/mall/src/main

   # 进入源代码目录
   cd $HOME/srccode/mall
   # 更新源代码
   git pull
   # 打包
   mvn clean package -Dmaven.test.skip=true -Ppro
   # 清除
   rm -rf $CATALINA_HOME/webapps/mall*
   rm -rf $CATALINA_HOME/work/Catalina/localhost/mall
   # 拷贝
   mv $HOME/srccode/mall/target/mall.war $CATALINA_HOME/webapps/
   ```

5. 运行脚本 `bash mall.sh`
6. 验证：使用浏览器访问 `http://ip:8080/mall`，如果能访问到项目首页，则说明部署成功了
7. (可选) [配置域名转发](#配置域名转发), 从而支持使用域名访问项目

## 配置域名转发

**示例**：监听域名 `mall.epoch.fun` 的请求并转发到 Tomcat 服务 `mall` 上

1. 在 Nginx 配置文件 `$NGINX_HOME/conf/nginx.conf` 的 `http` 节点中添加一个 `server` 配置

   ```
   server{
     listen 80;
     server_name mall.epoch.fun;
     
     location / {
       proxy_pass http://localhost:8080/mall/;
       # 解决 Nginx 反向代理丢失 Cookie / Session 的问题
       proxy_cookie_path  /mall /;
       add_header Access-Control-Allow-Origin '*';
     }
   }
   ```

2. 重载配置文件

   ```bash
   nginx -s reload 
   ```

[Vultr]: https://www.vultr.com/?ref=7242330
[阿里云万网]: https://wanwang.aliyun.com/domain
[阿里云解析]: https://wanwang.aliyun.com/domain/dns?spm=5176.12825654.eofdhaal5.83.2f422c4aDVSiFc&aly_as=Rt6uPSph
[软件安装文档]: 软件安装文档.md
[搭建 HTTP 图片服务器]: 图床搭建文档.md
[shell]: https://github.com/epochwz/shell
[数据表 SQL 文件]: https://raw.githubusercontent.com/epochwz/mall/master/docs/sqls/mall.sql
[生产环境配置文件]: https://raw.githubusercontent.com/epochwz/mall/master/docs/assets/resources-demo.tar
